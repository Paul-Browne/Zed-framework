<!DOCTYPE html>
<html>

<head>
    <link href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=" rel="icon" type="image/x-icon" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>simple shop</title>
    <script src="js/dot.min.js"></script>
    <script>
        // IIFE
        ! function(w, d) {
            // check if Z is already loaded
            if (!w.Z) {
                // object store
                w.Z = {};
                // PubSub store
                var topics = {};
                // filter for methods, not "html" or "entry"
                function filt(obj) {
                    return Object.keys(obj).filter(function(el) {
                        return el != "html" && el != "entry";
                    })[0];
                }
                // update method (simple PubSub publish)
                Z.update = function(obj) {
                    topics[filt(obj)] && topics[filt(obj)](obj);
                }
                // render
                Z.render = function(obj, noSubscribe) {
                    var x = filt(obj);
                    if (x && !noSubscribe) {
                        topics[x] = function(data) {
                            for (var key in data) {
                                obj[key] = data[key];
                            }
                            Z.render(obj, true);
                        };
                    }
                    // async ajax
                    var objResolved = {};
                    var arr = obj.html ? [obj.html] : [];
                    typeof obj[x] === 'string' ? arr.push(obj[x]) : Z[x] = obj[x];
                    arr.forEach(function(url, index) {
                        objResolved[index] = null;
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                objResolved[index] = xhr.responseText;
                                var allResolved = true;
                                for (var key in objResolved) {
                                    if (objResolved[key] === null) {
                                        allResolved = false;
                                    }
                                }
                                if (allResolved) {
                                    if (objResolved[1]) {
                                        Z[x] = JSON.parse(objResolved[1]);
                                    }
                                    obj.entry.innerHTML = objResolved[0];
                                    var scripts = new DOMParser().parseFromString(objResolved[0], 'text/html').querySelectorAll("SCRIPT");
                                    var i = 0;
                                    var j = scripts.length;
                                    while (i < j) {
                                        var newScript = d.createElement("SCRIPT");
                                        scripts[i].src ? newScript.src = scripts[i].src : newScript.innerHTML = scripts[i].innerHTML;
                                        d.head.appendChild(newScript);
                                        i++;
                                    }
                                }
                            }
                        };
                        xhr.open("GET", url, true);
                        xhr.send();
                    });
                }
            }
        // init    
        }(window, document);
    </script>
</head>

<body>
    <div id="basket"></div>
    <div id="products"></div>
    <div id="view"></div>
    <script>
    Z.render({
        html: "components/spa-shop/basket-simple.html",
        entry: document.getElementById("basket"),
        basket: {
            products: JSON.parse(localStorage.getItem("basket")) ||Â [],
            total: JSON.parse(localStorage.getItem("total")) || 0,
            update: function(){
                this.total = 0;
                this.products.forEach(function(product) {
                    this.total += (product.quantity * product.price);
                }, this)
                localStorage.setItem("basket", JSON.stringify(this.products));
                localStorage.setItem("total", JSON.stringify(this.total));
                Z.update({
                    basket: this
                })
            }
        }
    })

    Z.render({
        html: "components/spa-shop/products-simple.html",
        entry: document.getElementById("products"),
        products: "json/products-simple.json"
    })

    Z.render({
        html: "components/spa-shop/view-simple.html",
        entry: document.getElementById("view"),
        view: {}
    })
    </script>
</body>

</html>