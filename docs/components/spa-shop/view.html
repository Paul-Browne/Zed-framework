<div id="template-view" style="display:none;">
	{{? it.name }}
    <button onclick="Z.update({view: {}})">close</button>
    <ul>
    	<li>{{=it.name}}</li>
    </ul>

    <div>
    	
    	<select onchange="selectedVariant(this.value)">
    		{{~it.variants:value:index}}
    			{{? value.selected}}
    				<option selected value="{{=index}}">{{=value.variant}}</option>
    			{{??}}
    				<option value="{{=index}}">{{=value.variant}}</option>
    			{{?}}
	    	{{~}}
	    </select>
    	

    	{{~it.variants:value:index}}
    		{{? value.selected}}
    		<select onchange="selectedColor(this.value)">
    		{{~value.colors:v:i}}
    			{{? v.selected}}
    				{{? v.availability }}<option selected value="{{=v.color}}">{{=v.color}}</option>{{?}}
    			{{??}}
    				{{? v.availability }}<option value="{{=v.color}}">{{=v.color}}</option>{{?}}
    			{{?}}
    		{{~}}
    		</select>
    		{{?}}
    	{{~}}

    </div>

    <button onclick="addToBasket(Z.view)">Add To Cart</button>
    {{?}}


    <ol>
    	{{~it.compatibleAccessories:value:index}}
    	<li>{{=value.name}} <button onclick="addToBasket(Z.view.compatibleAccessories[{{=index}}])">Add To Cart</button></li>
    	{{~}}
    </ol>

</div>



<script>
	!function() {

		function preConstructAccessories(){
			Z.view.compatibleAccessories = [];
			Z.view.accessories.forEach(function(id){
				Z.products.accessories.forEach(function(accessory){
					if(accessory.id === id){
						Z.view.compatibleAccessories.push(accessory);
					}
				})
			})
		}
		Z.view.name && preConstructAccessories();

		function preConstructVariants(){
			var foundVariant = false;
			Z.view.variants.forEach(function(variant){
				var foundColor = false;
				if(variant.selected){
					foundVariant = true;
				}
				variant.selected = variant.selected || false;
				
				variant.colors.forEach(function(color){
					if(color.selected){
						foundColor = true;
					}
					color.selected = color.selected || false;
				})
				if(!foundColor){
					variant.colors[0].selected = true;
				}

			})
			if(!foundVariant){
				Z.view.variants[0].selected = true;
			}
		}
		Z.view.name && preConstructVariants();


	    var element = document.getElementById("template-view");
	    var template = doT.template(element.innerHTML);
	    element.innerHTML = template(Z.view);
	    element.style.display = '';

	}();
	function addToBasket(item){
		var newBasket = Z.basket;
		var found = false;
		newBasket.forEach(function(basketItem){
			if(basketItem.name === item.name){
				found = true
				basketItem.quantity = basketItem.quantity + 1;
			}
		})
		if(!found){
			item.quantity = 1;
			newBasket.push(item);
		}
		Z.update({
			basket: newBasket
		})
	}

	function selectedVariant(variant){
		Z.view.variants.forEach(function(v){
			v.selected = false;
		})
		Z.view.variants[variant].selected = true;
		Z.update({
			view: Z.view
		})
	}

	function selectedColor(color){
		Z.view.variants.forEach(function(v){
			v.colors.forEach(function(c){
				c.selected = false;
				if(color === c.color){
					c.selected = true;
				}
			})
		})
		Z.update({
			view: Z.view
		})
	}

</script>








