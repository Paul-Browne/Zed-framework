<template id="template-view">
    {{? it.name }}
    <style>
    .view-modal:before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: rgba(0, 0, 0, 0.4);
    }

    .view {
        background: #fff;
        border-radius: 6px;
        padding: 1em 2em;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-height: 100%;
        max-width: 100%;
        overflow: auto;
        box-sizing: border-box;
    }
    </style>
    <div class="view">
        <button onclick="Z.update({view: {}})">close</button>
        <h1>{{=it.name}}</h1>
        <h3>{{=it.templateObj.name}}</h3>
        {{?it.image}}
        <img src="images/{{=it.templateObj.image}}" width="250">
        {{?}}
        <div>
            {{? it.variants}}
            <select onchange="selectedVariant(this.value)">
                {{~it.variants:value:index}}
                {{? value.selected}}
                <option selected value="{{=index}}">{{=value.name}}</option>
                {{??}}
                <option value="{{=index}}">{{=value.name}}</option>
                {{?}}
                {{~}}
            </select>
            {{~it.variants:value:index}}
            {{? value.selected}}
            <select onchange="selectedColor(this.value)">
                {{~value.colors:v:i}}
                {{? v.selected}}
                <option selected value="{{=i}}">{{=v.name}}</option>
                {{??}}
                <option value="{{=i}}">{{=v.name}}</option>
                {{?}}
                {{~}}
            </select>
            {{?}}
            {{~}}
            {{?}}
        </div>
        <p>{{=it.templateObj.price}} â‚¬</p>
        <button onclick="addToBasket(Z.view)">Add To Cart</button>
        <div>
            {{~it.compatibleAccessories:value:index}}
            <div>{{=value.name}} <button onclick="Z.update({view:Z.view.compatibleAccessories[{{=index}}]})">view</button></div>
            {{~}}
        </div>
    </div>
    {{?}}
</template>
<div id="output-view" class="view-modal"></div>
<script>
! function() {

    function preConstructAccessories() {
        if (Z.view.accessories) {
            Z.view.compatibleAccessories = [];
            Z.view.accessories.forEach(function(id) {
                Z.products.forEach(function(product) {
                    if (product.type === "accessory" && product.id === id) {
                        Z.view.compatibleAccessories.push(product);
                    }
                })
            })
        }
    }

    function preConstructRemoveUnavailables() {
        if (Z.view.variants) {
            Z.view.variants.forEach(function(variant, index) {
                if ("availability" in variant && !variant.availability) {
                    Z.view.variants.splice(index, 1);
                }
                variant.colors.forEach(function(color, ind) {
                    if ("availability" in color && !color.availability) {
                        variant.colors.splice(ind, 1);
                    }
                })
            })
        }
    }

    function preConstructSelected() {
        if (Z.view.variants) {
            var foundVariant = false;
            Z.view.variants.forEach(function(variant) {
                if (variant.selected) {
                    foundVariant = true;
                }
                variant.selected = variant.selected || false;
                if (variant.colors) {
                    var foundColor = false;
                    variant.colors.forEach(function(color) {
                        if (color.selected) {
                            foundColor = true;
                        }
                        color.selected = color.selected || false;
                    })
                    if (!foundColor) {
                        variant.colors[0].selected = true;
                    }
                }
            })
            if (!foundVariant) {
                Z.view.variants[0].selected = true;
            }
        }
    }

    function preConstruct() {
        var templateObj = {
            name: Z.view.name,
            price: Z.view.price,
            image: Z.view.image
        };
        if (Z.view.variants) {
            Z.view.variants.forEach(function(variant) {
                if (variant.selected) {
                    if (variant.image) {
                        templateObj.image = variant.image;
                    }
                    if (variant.price) {
                        templateObj.price = variant.price;
                    }
                    if (variant.name) {
                        templateObj.name = (templateObj.name ? templateObj.name : "") + " " + variant.name;
                    }
                    if (variant.colors) {
                        variant.colors.forEach(function(color) {
                            if (color.selected) {
                                if (color.image) {
                                    templateObj.image = color.image;
                                }
                                if (color.price) {
                                    templateObj.price = color.price;
                                }
                                if (color.name) {
                                    templateObj.name = (templateObj.name ? templateObj.name : "") + " " + color.name;
                                }
                            }
                        })
                    }
                }
            })
        }
        Z.view.templateObj = templateObj;
    }

    preConstructAccessories();
    preConstructRemoveUnavailables();
    preConstructSelected();
    preConstruct();

    var template = doT.template(document.getElementById("template-view").innerHTML);
    document.getElementById("output-view").innerHTML = template(Z.view);

}();

function addToBasket(item) {
    var basketObj = {
        name: item.templateObj.name,
        price: item.templateObj.price
    };

    var found = false;
    Z.basket.products.forEach(function(basketItem) {
        if (basketItem.name === basketObj.name) {
            found = true
            basketItem.quantity = basketItem.quantity + 1;
        }
    })
    if (!found) {
        basketObj.quantity = 1;
        Z.basket.products.push(basketObj);
    }
    Z.basket.update();
}

function selectedVariant(index) {
    Z.view.variants.forEach(function(v) {
        v.selected = false;
    })
    Z.view.variants[index].selected = true;
    Z.update({
        view: Z.view
    })
}

function selectedColor(index) {
    Z.view.variants.forEach(function(v) {
        if (v.selected) {
            v.colors.forEach(function(c) {
                c.selected = false;
            })
            v.colors[index].selected = true;
        }
    })
    Z.update({
        view: Z.view
    })
}
</script>