<!DOCTYPE html>
<html>

<head>
    <link href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=" rel="icon" type="image/x-icon" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="Z.js"></script>
    <!--
    <script type="text/javascript">
    ! function(w, d) {
        if (!w.Z) {
            w.Z = {};

            // function isInViewport(element, offset) {
            //     return element.getBoundingClientRect().top <= (+offset + w.innerHeight);
            // }

            function ajax(url, cb) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var res = xhr.responseText;
                        cb(res);
                    }
                };
                xhr.open("GET", url, true);
                xhr.send();
            }

            function xyz(obj, html) {
                obj.container.innerHTML = html;
                var scripts = new DOMParser().parseFromString(html, 'text/html').querySelectorAll("SCRIPT");
                var i = 0;
                var j = scripts.length;
                while (i < j) {
                    var newScript = d.createElement("SCRIPT");
                    scripts[i].src ? newScript.src = scripts[i].src : newScript.innerHTML = scripts[i].innerHTML;
                    d.head.appendChild(newScript);
                    i++;
                }
            }

            function subscriber(channel, obj) {
                sub(channel, function(message, data) {
                    for (var key in data) {
                        obj[key] = data[key];
                    }
                    //obj.listen = "";
                    Z.render(obj, true);
                });
            }

            function filt(el) {
              return el != "html" && el != "container";
            }

            Z.update = function(obj) {
                pub(Object.keys(obj)[0], obj);
            }

            Z.render = function(obj, noSubscribe) {
                var x = Object.keys(obj).filter(filt)[0];
                if (x && !noSubscribe) {
                    //console.log(x);
                    // if (Array.isArray(x)) {
                    //     obj.listen.forEach(function(el) {
                    //         subscriber(el, obj);
                    //     });
                    // } else {
                    subscriber(x, obj);
                    //}
                }
                if (typeof obj[x] === 'string') {
                    // serial not parallel!
                    ajax(obj[x], function(json) {
                        w.Z[x] = JSON.parse(json);
                        ajax(obj.html, function(res) {
                            xyz(obj, res);
                        });
                    });
                } else {
                    w.Z[x] = obj[x];
                    ajax(obj.html, function(res) {
                        xyz(obj, res);
                    });
                }
            }

            var topics = {};
            //var subUid = -1;
            //var sub = function(topic, f) {
            function sub(topic, f) {
                // if (!topics[topic]) {
                //     topics[topic] = [];
                // }
                topics[topic] = topics[topic] || [];
                //var t = (++subUid) + "";
                topics[topic].push({
                    //t: t,
                    f: f
                });
                //return t;
            };
            //var pub = function(topic, args) {
            function pub(topic, args) {
                // console.log(topics, topic, args);
                // if (!topics[topic]) {
                //     return false;
                // }
                //setTimeout(function() {
                    
                var subscribers = topics[topic];
                var len = subscribers ? subscribers.length : 0;

                while (len--) {
                    // console.log("fired setTimeout");
                    subscribers[len].f(topic, args);
                }
                //}, 0);
                //return true;
            };
            // state.unsub = function(t) {
            //     for (var m in topics) {
            //         if (topics[m]) {
            //             for (var i = 0, j = topics[m].length; i < j; i++) {
            //                 if (topics[m][i].t === t) {
            //                     topics[m].splice(i, 1);
            //                     return t;
            //                 }
            //             }
            //         }
            //     }
            //     return false;
            // };
        }
    }(window, document);
    </script>
    -->
</head>

<body>
    <h1>Hello world!!</h1>
    <div id="entry"></div>
    <div id="entry2"></div>
    <div id="entry3"></div>

    <script>
    Z.render({
        html: "hi.html",
        container: document.getElementById("entry"),
        bob: "test.json"
        // lazy: 150
    })
    Z.render({
        html: "test2.html",
        container: document.getElementById("entry2"),
        test2: { boom: "boooommm!!" }
    })
    Z.render({
        html: "people.html",
        container: document.getElementById("entry3"),
        people: [
            { name: "Paul", job: "developer", age: 36, sex: "Male" },
            { name: "Mike", job: "teacher", age: 32, sex: "Male" },
            { name: "Sarah", job: "doctor", age: 39, sex: "Female" }
        ]
    })

    setTimeout(function() {
        Z.update({
            bob: "test2.json"
        })
        Z.update({
            test2: {boom: "robin"}
        })
        Z.update({
            qwerty: {boom: "NO NO NO NO NO NO!!"}
        })
    }, 2000)
    // setTimeout(function() {
    //     Z.update({
    //         bob: "test.json"
    //     })
    //     Z.update({
    //         test2: {boom: "jesus"}
    //     })
    // }, 3000)
    // setTimeout(function() {
    //     Z.update({
    //         bob: "test2.json"
    //     })
    //     Z.update({
    //         test2: {boom: "catwoman"}
    //     })
    // }, 4000)
    setTimeout(function() {
        // Z.update({
        //     bob: "test.json"
        // })
        // Z.update({
        //     test2: {boom: "sting"}
        // })
        // Z.update({
        //     xyz: {boom: "NO NO NO NO NO NO!!"}
        // })
        var thomas = {
            name: "Thomas", job: "King", age: 40, sex: "Male"
        };
        Z.people.push(thomas);
        Z.update({
            html: "people2.html",
            people: Z.people
        })
    }, 3000)

    setTimeout(function() {
        Z.update({
            html: "people.html",
            people: [
                { name: "Paul", job: "developer", age: 36, sex: "Male" },
                { name: "Mike", job: "teacher", age: 32, sex: "Male" },
                { name: "Sarah", job: "doctor", age: 39, sex: "Female" }
            ]
        })
    }, 10000)

    </script>
</body>

</html>